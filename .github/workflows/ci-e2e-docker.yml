# CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - åŠ¹ç‡çš„ãªä¸¦åˆ—å®Ÿè¡Œã¨ãƒ†ã‚¹ãƒˆ
#
# å®Ÿè¡Œãƒ•ãƒ­ãƒ¼:
# 1. ä¸¦åˆ—å®Ÿè¡Œ: fmt, lint, docker-build
# 2. E2Eãƒ†ã‚¹ãƒˆ: docker-buildå®Œäº†å¾Œã«Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# 3. ãã®ä»–ãƒ†ã‚¹ãƒˆ: fmt/lintå®Œäº†å¾Œã«å®Ÿè¡Œ
# 4. å…¨å®Œäº†å¾Œ: developâ†’mainè‡ªå‹•ãƒãƒ¼ã‚¸

name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - main

jobs:
  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—1: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --silent
        timeout-minutes: 3

      - name: Check formatting
        run: npm run fmt:check
        timeout-minutes: 1

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—1: ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
  lint-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --silent
        timeout-minutes: 3

      - name: Run lint
        run: npm run lint
        timeout-minutes: 2

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—1: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.image-info.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set repository info
        id: image-info
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="ghcr.io/${REPO_OWNER_LOWER}/msearch-e2e:latest"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "repo-owner=${REPO_OWNER_LOWER}" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.e2e
          push: true
          tags: ${{ steps.image-info.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # E2Eãƒ†ã‚¹ãƒˆ: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å®Œæˆå¾Œã«å®Ÿè¡Œ
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [docker-build]
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests
        run: |
          echo "ğŸ³ Running E2E tests with Playwright in Docker"
          docker run --rm \
            -v ${{ github.workspace }}:/app:ro \
            -w /app \
            -e CI=true \
            -e NODE_ENV=test \
            ${{ needs.docker-build.outputs.image-tag }} \
            test:e2e-ci
        timeout-minutes: 10

  # ãã®ä»–ãƒ†ã‚¹ãƒˆ: lint/formatå®Œäº†å¾Œã«å®Ÿè¡Œ
  unit-tests:
    runs-on: ubuntu-latest
    needs: [format-check, lint-check]
    strategy:
      matrix:
        test-type: [unit, lightweight]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
          export PUPPETEER_SKIP_DOWNLOAD=1
          npm ci --prefer-offline --no-audit --no-fund --silent
        timeout-minutes: 3

      - name: Run ${{ matrix.test-type }} tests
        run: |
          export CI=true NODE_ENV=test
          npm run test:${{ matrix.test-type }}
        timeout-minutes: 5

  # å…¨ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œ: developâ†’mainè‡ªå‹•ãƒãƒ¼ã‚¸
  merge-to-main:
    needs: [format-check, lint-check, docker-build, e2e-tests, unit-tests]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Merge to main
        run: |
          git checkout main
          git merge develop --no-ff -m "ğŸ”€ Merge develop to main [skip ci]"
          git push origin main
