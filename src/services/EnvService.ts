/**
 * EnvService - Environment variable configuration service
 * Single Responsibility: Environment setup and configuration management
 */

import { promises as fs } from "fs";
import { homedir } from "os";
import { join } from "path";
import * as readline from "readline";

export class EnvService {
  private readonly envFiles = [".env.local", ".env"];
  private readonly bashrcPath = join(homedir(), ".bashrc");
  private readonly zshrcPath = join(homedir(), ".zshrc");

  /**
   * Check current environment status
   */
  public async checkStatus(): Promise<void> {
    console.log("ğŸ” ç’°å¢ƒè¨­å®šçŠ¶æ³:\n");

    // Check environment variable
    const apiKey = process.env.FOURSQUARE_API_KEY;
    if (apiKey) {
      console.log("âœ… FOURSQUARE_API_KEY: è¨­å®šæ¸ˆã¿");
      console.log(
        `   å€¤: ${apiKey.substring(0, 10)}...${apiKey.substring(apiKey.length - 4)}`,
      );
    } else {
      console.log("âŒ FOURSQUARE_API_KEY: æœªè¨­å®š");
    }

    // Check .env files
    console.log("\nğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«:");
    for (const file of this.envFiles) {
      try {
        await fs.access(file);
        console.log(`âœ… ${file}: å­˜åœ¨`);
      } catch {
        console.log(`âŒ ${file}: æœªä½œæˆ`);
      }
    }

    // Check shell config files
    console.log("\nğŸš ã‚·ã‚§ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:");
    for (const file of [this.bashrcPath, this.zshrcPath]) {
      try {
        await fs.access(file);
        const content = await fs.readFile(file, "utf8");
        if (content.includes("FOURSQUARE_API_KEY")) {
          console.log(`âœ… ${file}: msearchè¨­å®šã‚ã‚Š`);
        } else {
          console.log(`âšª ${file}: å­˜åœ¨ï¼ˆmsearchè¨­å®šãªã—ï¼‰`);
        }
      } catch {
        console.log(`âŒ ${file}: æœªä½œæˆ`);
      }
    }

    console.log("\nğŸ’¡ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®çŠ¶æ…‹:");
    if (apiKey) {
      console.log("âœ… æœ‰åŠ¹ - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™");
    } else {
      console.log("âŒ ç„¡åŠ¹ - åŸºæœ¬æ¤œç´¢ã®ã¿åˆ©ç”¨å¯èƒ½");
      console.log("   ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯: msearch --setup");
    }
  }

  /**
   * Interactive setup for environment variables
   */
  public async setupInteractive(): Promise<void> {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });

    console.log("ğŸï¸ msearch ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n");
    console.log(
      "ğŸ“– Foursquare API ã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã™:",
    );
    console.log("   â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»è©•ä¾¡è¡¨ç¤º");
    console.log("   ğŸ’° ä¾¡æ ¼å¸¯æƒ…å ±");
    console.log("   ğŸ“ é›»è©±ç•ªå·ãƒ»å–¶æ¥­æ™‚é–“");
    console.log("   ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURL\n");

    console.log(
      "ğŸ†“ Foursquare API ç„¡æ–™æ : æœˆ40,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå€‹äººåˆ©ç”¨ã«ã¯ååˆ†ï¼‰\n",
    );

    try {
      const setupChoice = await this.askQuestion(
        rl,
        "è¨­å®šã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ (y/N): ",
      );

      if (
        setupChoice.toLowerCase() !== "y" &&
        setupChoice.toLowerCase() !== "yes"
      ) {
        console.log(
          "ğŸ’¡ ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚åŸºæœ¬æ¤œç´¢æ©Ÿèƒ½ã¯å¼•ãç¶šãåˆ©ç”¨ã§ãã¾ã™ã€‚",
        );
        rl.close();
        return;
      }

      console.log("\nğŸ”‘ Foursquare API ã‚­ãƒ¼å–å¾—æ–¹æ³•:");
      console.log("1. https://foursquare.com/developers/ ã«ã‚¢ã‚¯ã‚»ã‚¹");
      console.log("2. ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ");
      console.log('3. æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’ä½œæˆï¼ˆåå‰ã¯ "msearch" ãªã©é©å½“ã«ï¼‰');
      console.log("4. API ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼");

      const apiKey = await this.askQuestion(
        rl,
        "\nFoursquare API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ",
      );

      if (!apiKey.trim()) {
        console.log("âŒ API ã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
        rl.close();
        return;
      }

      const configChoice = await this.askQuestion(
        rl,
        "\nè¨­å®šæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„:\n" +
          "1. .env ãƒ•ã‚¡ã‚¤ãƒ« (ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿)\n" +
          "2. shellè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š)\n" +
          "é¸æŠ (1/2): ",
      );

      if (configChoice === "1") {
        await this.setupEnvFile(apiKey.trim());
      } else if (configChoice === "2") {
        await this.setupShellConfig(apiKey.trim());
      } else {
        console.log("âŒ ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚");
        rl.close();
        return;
      }

      console.log("\nâœ… è¨­å®šå®Œäº†ï¼");
      console.log("ğŸ§ª å‹•ä½œç¢ºèª: msearch ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ -l");
      console.log("ğŸ“Š è¨­å®šçŠ¶æ³ç¢ºèª: msearch --status");
    } catch (error) {
      console.error("âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    } finally {
      rl.close();
    }
  }

  /**
   * Setup .env file
   */
  private async setupEnvFile(apiKey: string): Promise<void> {
    const envContent = `# msearch environment configuration
# Generated by: msearch --setup

# Foursquare Places API Key
# Used for reviews, ratings, and additional POI data
FOURSQUARE_API_KEY=${apiKey}
`;

    try {
      await fs.writeFile(".env.local", envContent);
      console.log("âœ… .env.local ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ");
    } catch (error) {
      console.error("âŒ .env.local ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  }

  /**
   * Setup shell configuration
   */
  private async setupShellConfig(apiKey: string): Promise<void> {
    const shellLine = `\n# msearch configuration\nexport FOURSQUARE_API_KEY="${apiKey}"\n`;

    // Detect current shell
    const shell = process.env.SHELL || "";
    let targetFile = this.bashrcPath;

    if (shell.includes("zsh")) {
      targetFile = this.zshrcPath;
    }

    try {
      await fs.appendFile(targetFile, shellLine);
      console.log(`âœ… ${targetFile} ã«è¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      console.log("ğŸ”„ æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã‹ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:");
      console.log(`   source ${targetFile}`);
    } catch (error) {
      console.error(`âŒ ${targetFile} ã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
    }
  }

  /**
   * Helper function for readline questions
   */
  private askQuestion(
    rl: readline.Interface,
    question: string,
  ): Promise<string> {
    return new Promise((resolve) => {
      rl.question(question, (answer: string) => {
        resolve(answer);
      });
    });
  }

  /**
   * Generate .env.example file
   */
  public async generateEnvExample(): Promise<void> {
    const exampleContent = `# Environment Variables for msearch
# Copy this file to .env.local and set your API keys

# Foursquare Places API Key (Optional)
# Used for reviews, ratings, and additional POI data
# Get your free API key at: https://foursquare.com/developers/
# Free tier: 40,000 requests per month (sufficient for personal use)
FOURSQUARE_API_KEY=your_foursquare_api_key_here

# Note: OpenStreetMap Overpass API is free and doesn't require an API key
# The tool will work without FOURSQUARE_API_KEY, but won't show reviews/ratings

# Quick setup: msearch --setup
# Status check: msearch --status
`;

    try {
      await fs.writeFile(".env.example", exampleContent);
      console.log("âœ… .env.example ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
    } catch (error) {
      console.error("âŒ .env.example ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  }

  /**
   * Show environment setup help
   */
  public showSetupHelp(): void {
    console.log(`
ğŸï¸ msearch ç’°å¢ƒè¨­å®šãƒ˜ãƒ«ãƒ—

ğŸ“Š ç¾åœ¨ã®è¨­å®šçŠ¶æ³ç¢ºèª:
   msearch --status

ğŸ”§ å¯¾è©±å¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
   msearch --setup

ğŸ”‘ æ‰‹å‹•è¨­å®šæ–¹æ³•:

1. ğŸ“ .env ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š:
   echo "FOURSQUARE_API_KEY=your_api_key" > .env.local

2. ğŸš ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š (bash):
   echo 'export FOURSQUARE_API_KEY="your_api_key"' >> ~/.bashrc
   source ~/.bashrc

3. ğŸš ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š (zsh):
   echo 'export FOURSQUARE_API_KEY="your_api_key"' >> ~/.zshrc
   source ~/.zshrc

ğŸ†“ Foursquare API ã‚­ãƒ¼å–å¾—:
   https://foursquare.com/developers/

ğŸ’¡ æ³¨æ„äº‹é …:
   - API ã‚­ãƒ¼ãªã—ã§ã‚‚åŸºæœ¬æ¤œç´¢ã¯å‹•ä½œã—ã¾ã™
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»è©•ä¾¡æ©Ÿèƒ½ã«ã¯API ã‚­ãƒ¼ãŒå¿…è¦ã§ã™
   - ç„¡æ–™æ : æœˆ40,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (å€‹äººåˆ©ç”¨ã«ã¯ååˆ†)
`);
  }
}
